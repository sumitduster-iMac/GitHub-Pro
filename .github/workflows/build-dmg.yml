name: Build DMG

on:
  workflow_dispatch:
    inputs:
      architecture:
        description: 'Architecture to build'
        required: true
        default: 'universal'
        type: choice
        options:
          - universal
          - x86_64
          - arm64
  push:
    tags:
      - 'v*'  # Trigger on version tags like v1.0.0

jobs:
  build-dmg:
    name: Build macOS DMG
    runs-on: macos-latest
    
    permissions:
      contents: write  # Required to upload release assets
      
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install py2app
      
      - name: Determine architecture
        id: arch
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "arch=${{ inputs.architecture }}" >> $GITHUB_OUTPUT
          else
            echo "arch=universal" >> $GITHUB_OUTPUT
          fi
      
      - name: Build DMG
        run: |
          chmod +x create_dmg.sh
          ./create_dmg.sh --arch ${{ steps.arch.outputs.arch }}
      
      - name: Get version
        id: version
        run: |
          if [ ! -f "macos_github_overlay/about/version.txt" ]; then
            echo "Error: version.txt not found"
            exit 1
          fi
          VERSION_RAW=$(cat macos_github_overlay/about/version.txt)
          VERSION=$(printf "%s" "$VERSION_RAW" | tr -d ' \t\r\n')
          if [ -z "$VERSION" ]; then
            echo "Error: version.txt is empty or invalid."
            echo "  Raw content: '$VERSION_RAW'"
            echo "  Trimmed value: '$VERSION'"
            echo "  Expected format: X.Y.Z (e.g., 1.2.3)"
            exit 1
          fi
          # Validate version format (X.Y.Z)
          if ! echo "$VERSION" | grep -Eq '^[0-9]+\.[0-9]+\.[0-9]+$'; then
            echo "Error: version '$VERSION' from version.txt is not in the expected format X.Y.Z"
            exit 1
          fi
          # If this workflow was triggered by a tag (e.g., refs/tags/v1.2.3),
          # ensure the tag version (without leading 'v') matches VERSION.
          if [ -n "${GITHUB_REF:-}" ] && echo "$GITHUB_REF" | grep -qE '^refs/tags/'; then
            TAG="${GITHUB_REF#refs/tags/}"
            TAG_VERSION="${TAG#v}"
            if [ "$TAG_VERSION" != "$VERSION" ]; then
              echo "Error: version mismatch between tag and version.txt"
              echo "  Tag version (after stripping 'v'): $TAG_VERSION"
              echo "  version.txt: $VERSION"
              exit 1
            fi
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"
      
      - name: Rename DMG with version and architecture
        run: |
          ARCH="${{ steps.arch.outputs.arch }}"
          VERSION="${{ steps.version.outputs.version }}"
          if [ -f "macos-github-overlay.dmg" ]; then
            mv "macos-github-overlay.dmg" "macos-github-overlay-${VERSION}-${ARCH}.dmg"
            echo "Created: macos-github-overlay-${VERSION}-${ARCH}.dmg"
          else
            echo "Error: macos-github-overlay.dmg not found"
            ls -la *.dmg || echo "No DMG files found"
            exit 1
          fi
      
      - name: Upload DMG as artifact
        uses: actions/upload-artifact@v4
        with:
          name: macos-github-overlay-${{ steps.arch.outputs.arch }}-dmg
          path: macos-github-overlay-*.dmg
          retention-days: 30
      
      - name: Upload to Release
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v1
        with:
          files: macos-github-overlay-*.dmg
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
